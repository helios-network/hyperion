<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperion Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <style>
        [v-cloak] {
            display: none;
        }
        .chain-card {
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <v-app>
            <!-- Login Page -->
            <v-container v-if="!isAuthenticated" fluid class="fill-height">
                <v-row align="center" justify="center">
                    <v-col cols="12" sm="8" md="4">
                        <v-card class="elevation-12">
                            <v-toolbar color="primary" dark flat>
                                <v-toolbar-title>Hyperion Login</v-toolbar-title>
                            </v-toolbar>
                            <v-card-text>
                                <v-form @submit.prevent="login">
                                    <v-text-field
                                        v-model="password"
                                        :append-icon="showPassword ? 'mdi-eye' : 'mdi-eye-off'"
                                        :type="showPassword ? 'text' : 'password'"
                                        label="Password"
                                        @click:append="showPassword = !showPassword"
                                    ></v-text-field>
                                    <v-alert v-if="error" type="error" dense>
                                        {{ error }}
                                    </v-alert>
                                </v-form>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="primary" @click="login">Login</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-col>
                </v-row>
            </v-container>

            <!-- Dashboard -->
            <v-container v-else-if="!showTokensPage && !showRpcsPage && !showSettingsPage">
                <v-row>
                    <v-col cols="12">
                        <v-card>
                            <v-card-title class="d-flex align-center">
                                <div>Hyperion Chains</div>
                                <v-spacer></v-spacer>
                                <v-tooltip bottom>
                                    <template v-slot:activator="{ on, attrs }">
                                        <div 
                                            class="text-subtitle-2 grey--text mr-4" 
                                            v-bind="attrs" 
                                            v-on="on"
                                            style="cursor: pointer"
                                            @click="copyToClipboard(walletAddress)"
                                        >
                                            {{ walletAddress }}
                                        </div>
                                    </template>
                                    Click to copy address
                                </v-tooltip>
                                <v-btn color="primary" @click="showAddChainDialog = true">
                                    Add Chain
                                </v-btn>
                            </v-card-title>
                            <v-card-text>
                                <v-row>
                                    <v-col v-for="(chain, id) in chains" :key="id" cols="12" md="6" lg="4">
                                        <v-card class="chain-card">
                                            <v-card-text>
                                                <div class="text-h6 mb-2">Chain ID: {{ chain.chainId }}</div>
                                                <v-list dense>
                                                    <v-list-item v-if="chain.name !== undefined">
                                                        <v-list-item-content>
                                                            <v-list-item-title>Name</v-list-item-title>
                                                            <v-list-item-subtitle>{{ chain.name }}</v-list-item-subtitle>
                                                        </v-list-item-content>
                                                    </v-list-item>
                                                    <v-list-item>
                                                        <v-list-item-content>
                                                            <v-list-item-title>Address</v-list-item-title>
                                                            <v-list-item-subtitle>{{ chain.address }}</v-list-item-subtitle>
                                                        </v-list-item-content>
                                                    </v-list-item>
                                                    <v-list-item>
                                                        <v-list-item-content>
                                                            <v-list-item-title>Status</v-list-item-title>
                                                            <v-list-item-subtitle>
                                                                <v-chip
                                                                    :color="chain.running ? 'success' : 'error'"
                                                                    small
                                                                >
                                                                    {{ chain.running ? 'Running' : 'Stopped' }}
                                                                </v-chip>
                                                                <v-chip
                                                                    :color="chain.registered ? 'success' : 'warning'"
                                                                    small
                                                                    class="ml-2"
                                                                >
                                                                    {{ chain.registered ? 'Registered' : 'Unregistered' }}
                                                                </v-chip>
                                                                <v-chip
                                                                    v-if="chain.paused"
                                                                    color="warning"
                                                                    small
                                                                    class="ml-2"
                                                                >
                                                                    Paused
                                                                </v-chip>
                                                                <v-chip
                                                                    :color="chain.isSynced ? 'success' : 'error'"
                                                                    small
                                                                    class="ml-2"
                                                                >
                                                                    {{ chain.isSynced ? 'Synced' : 'Out of Sync' }}
                                                                </v-chip>
                                                            </v-list-item-subtitle>
                                                        </v-list-item-content>
                                                    </v-list-item>
                                                    <v-list-item v-if="chain.height > 0">
                                                        <v-list-item-content>
                                                            <v-list-item-title>Sync Status</v-list-item-title>
                                                            <v-list-item-subtitle>
                                                                Height: {{ chain.height }} | Target: {{ chain.targetHeight }} | Diff: {{ chain.heightDiff }}
                                                            </v-list-item-subtitle>
                                                            <v-list-item-title>Stats</v-list-item-title>
                                                            <v-list-item-subtitle>
                                                                Total Txs: {{ chain.totalTxs }} | Batches: {{ chain.batches }}
                                                            </v-list-item-subtitle>
                                                        </v-list-item-content>
                                                    </v-list-item>
                                                </v-list>
                                                <v-card-actions>
                                                    <v-spacer></v-spacer>
                                                    <v-btn
                                                        v-if="!chain.running && chain.proposed && chain.registered"
                                                        color="success"
                                                        @click="runHyperion(chain.chainId)"
                                                        :loading="chain.isLoading"
                                                    >
                                                        Run
                                                    </v-btn>
                                                    <v-btn
                                                        v-if="chain.running"
                                                        color="error"
                                                        @click="stopHyperion(chain.chainId)"
                                                        :loading="chain.isLoading"
                                                    >
                                                        Stop
                                                    </v-btn>
                                                    <v-btn
                                                        v-if="!chain.proposed"
                                                        color="primary"
                                                        @click="openProposeDialog(chain.chainId)"
                                                        :loading="chain.isLoading"
                                                        class="ml-2"
                                                    >
                                                        Propose
                                                    </v-btn>
                                                    <v-btn
                                                        v-if="chain.registered && !chain.running"
                                                        color="warning"
                                                        @click="unregisterHyperion(chain.chainId)"
                                                        :loading="chain.isLoading"
                                                        class="ml-2"
                                                    >
                                                        Unregister
                                                    </v-btn>
                                                    <v-btn
                                                        v-if="!chain.registered && chain.proposed"
                                                        color="info"
                                                        @click="registerHyperion(chain.chainId)"
                                                        :loading="chain.isLoading"
                                                        class="ml-2"
                                                    >
                                                        Register
                                                    </v-btn>
                                                </v-card-actions>
                                                <v-card-actions>
                                                    <v-btn
                                                        v-if="chain.proposed"
                                                        color="info"
                                                        @click="viewTokens(chain.chainId)"
                                                        class="mr-2"
                                                    >
                                                        Tokens
                                                    </v-btn>
                                                    <v-btn
                                                        color="info"
                                                        @click="viewRpcs(chain.chainId)"
                                                        class="mr-2"
                                                    >
                                                        RPCs
                                                    </v-btn>
                                                    <v-btn
                                                        color="info"
                                                        @click="viewSettings(chain.chainId)"
                                                        class="mr-2"
                                                    >
                                                        Settings
                                                    </v-btn>
                                                    <v-spacer></v-spacer>
                                                </v-card-actions>
                                            </v-card-text>
                                        </v-card>
                                    </v-col>
                                </v-row>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>

                <!-- Transactions Table -->
                <v-row class="mt-4">
                    <v-col cols="12">
                        <v-card>
                            <v-card-title>
                                Recent Transactions
                            </v-card-title>
                            <v-card-text>
                                <v-data-table
                                    :headers="[
                                        { text: 'Chain ID', value: 'chain_id' },
                                        { text: 'Type', value: 'tx_type' },
                                        { text: 'Transaction Hash', value: 'tx_hash' },
                                        { text: 'Block Height', value: 'block_height' },
                                        { text: 'Token Contract', value: 'token_contract' },
                                        { text: 'Fees Taken', value: 'fees_taken' },
                                        { text: 'Cost', value: 'cost' },
                                        { text: 'Timestamp', value: 'timestamp' }
                                    ]"
                                    :items="transactions"
                                    :loading="isLoadingTransactions"
                                    :options.sync="transactionTableOptions"
                                    :server-items-length="totalTransactions"
                                    :footer-props="{
                                        'items-per-page-options': [5, 10, 20, 50],
                                        showFirstLastPage: true
                                    }"
                                >
                                    <template v-slot:item.tx_hash="{ item }">
                                        <v-tooltip bottom>
                                            <template v-slot:activator="{ on, attrs }">
                                                <span v-bind="attrs" v-on="on">{{ item.tx_hash }}</span>
                                            </template>
                                            <v-btn
                                                text
                                                small
                                                @click="copyToClipboard(item.tx_hash)"
                                            >
                                                Click to copy
                                            </v-btn>
                                        </v-tooltip>
                                    </template>
                                    <template v-slot:item.token_contract="{ item }">
                                        <v-tooltip bottom>
                                            <template v-slot:activator="{ on, attrs }">
                                                <span v-bind="attrs" v-on="on">{{ item.token_contract }}</span>
                                            </template>
                                            <v-btn
                                                text
                                                small
                                                @click="copyToClipboard(item.token_contract)"
                                            >
                                                Click to copy
                                            </v-btn>
                                        </v-tooltip>
                                    </template>
                                </v-data-table>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>

                <!-- Add Chain Dialog -->
                <v-dialog v-model="showAddChainDialog" max-width="500px">
                    <v-card>
                        <v-card-title>Add New Chain</v-card-title>
                        <v-card-text>
                            <v-text-field
                                v-model="newChainId"
                                label="Chain ID"
                                type="number"
                            ></v-text-field>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="error" text @click="showAddChainDialog = false">Cancel</v-btn>
                            <v-btn 
                                color="primary" 
                                @click="deployHyperion"
                                :loading="isDeploying"
                                :disabled="isDeploying"
                            >
                                Deploy
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>

                <!-- Propose Hyperion Dialog -->
                <v-dialog v-model="showProposeDialog" max-width="600px">
                    <v-card>
                        <v-card-title>Propose Hyperion</v-card-title>
                        <v-card-text>
                            <v-form ref="proposeForm">
                                <v-text-field
                                    v-model="proposeForm.title"
                                    label="Title"
                                    required
                                    :rules="[v => !!v || 'Title is required']"
                                ></v-text-field>
                                <v-textarea
                                    v-model="proposeForm.description"
                                    label="Description"
                                    required
                                    :rules="[v => !!v || 'Description is required']"
                                ></v-textarea>
                                <v-text-field
                                    v-model="proposeForm.bridge_chain_id"
                                    label="Bridge Chain ID"
                                    type="number"
                                    disabled
                                ></v-text-field>
                                <v-text-field
                                    v-model="proposeForm.bridge_chain_name"
                                    label="Bridge Chain Name"
                                    required
                                    :rules="[v => !!v || 'Bridge Chain Name is required']"
                                ></v-text-field>
                                <v-text-field
                                    v-model="proposeForm.average_counterparty_block_time"
                                    label="Average Block Time (ms)"
                                    type="number"
                                    required
                                    :rules="[
                                        v => !!v || 'Block time is required',
                                        v => v > 0 || 'Block time must be positive'
                                    ]"
                                ></v-text-field>
                            </v-form>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="error" text @click="showProposeDialog = false">Cancel</v-btn>
                            <v-btn color="primary" @click="proposeHyperion" :loading="isProposing">
                                Propose
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
            </v-container>

            <!-- RPCs Page -->
            <v-container v-else-if="showRpcsPage">
                <v-row>
                    <v-col cols="12">
                        <v-card>
                            <v-card-title>
                                RPCs for Chain {{ selectedChainId }}
                                <v-spacer></v-spacer>
                                <v-btn color="primary" @click="showAddRpcsDialog = true">
                                    Add RPCs
                                </v-btn>
                                <v-btn color="secondary" class="ml-2" @click="showRpcsPage = false">
                                    Back to Chains
                                </v-btn>
                            </v-card-title>
                            <v-card-text>
                                <v-data-table
                                    :headers="[
                                        { text: 'RPC URL', value: 'url' },
                                        { text: 'Reputation', value: 'reputation' }
                                    ]"
                                    :items="rpcs"
                                    :loading="isLoadingRpcs"
                                >
                                    <template v-slot:item.url="{ item }">
                                        <v-tooltip bottom>
                                            <template v-slot:activator="{ on, attrs }">
                                                <span v-bind="attrs" v-on="on">{{ item.url }}</span>
                                            </template>
                                            <v-btn
                                                text
                                                small
                                                @click="copyToClipboard(item.url)"
                                            >
                                                Click to copy
                                            </v-btn>
                                        </v-tooltip>
                                    </template>
                                </v-data-table>
                            </v-card-text>
                        </v-card>
                        <v-card>
                            <v-card-title>Static RPCs</v-card-title>
                            <v-card-text>
                                <v-list>
                                    <v-list-item v-for="rpc in staticRpcs" :key="rpc">
                                        <v-list-item-content>
                                            <v-list-item-title>{{ rpc }}</v-list-item-title>
                                        </v-list-item-content>
                                        <v-list-item-action>
                                            <v-btn
                                                icon
                                                small
                                                color="error"
                                                @click="removeRpc(rpc)"
                                                :loading="isDeletingRpc === rpc"
                                            >
                                                <v-icon>mdi-delete</v-icon>
                                            </v-btn>
                                        </v-list-item-action>
                                    </v-list-item>
                                </v-list>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>

                <!-- Add RPCs Dialog -->
                <v-dialog v-model="showAddRpcsDialog" max-width="500px">
                    <v-card>
                        <v-card-title>Add New RPCs</v-card-title>
                        <v-card-text>
                            <v-form ref="rpcsForm">
                                <v-textarea
                                    v-model="newRpcs"
                                    label="RPCs (rpc1,rpc2,rpc3)"
                                    hint="Enter RPCs separated by commas"
                                    persistent-hint
                                    required
                                    :rules="[v => !!v || 'At least one RPC is required']"
                                ></v-textarea>
                            </v-form>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="error" text @click="showAddRpcsDialog = false">Cancel</v-btn>
                            <v-btn 
                                color="primary" 
                                @click="addRpcs"
                                :loading="isAddingRpcs"
                            >
                                Add
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
            </v-container>

            <!-- Tokens Page -->
            <v-container v-else-if="showTokensPage">
                <v-row>
                    <v-col cols="12">
                        <v-card>
                            <v-card-title>
                                Tokens for Chain {{ selectedChainId }}
                                <v-spacer></v-spacer>
                                <v-btn color="primary" @click="showAddTokenDialog = true">
                                    Add Token
                                </v-btn>
                                <v-btn color="secondary" class="ml-2" @click="showTokensPage = false">
                                    Back to Chains
                                </v-btn>
                            </v-card-title>
                            <v-card-text>
                                <v-data-table
                                    :headers="[
                                        { text: 'Name', value: 'name' },
                                        { text: 'Symbol', value: 'symbol' },
                                        { text: 'Decimals', value: 'decimals' },
                                        { text: 'Contract Address', value: 'contract_address' },
                                        { text: 'Chain Contract Address', value: 'chain_contract_address' },
                                        { text: 'Origin ChainId', value: 'origin_chain_id' }
                                    ]"
                                    :items="tokens"
                                    :loading="isLoadingTokens"
                                    :options.sync="tableOptions"
                                    :server-items-length="totalItems"
                                    :footer-props="{
                                        'items-per-page-options': [5, 10, 20, 50],
                                        showFirstLastPage: true
                                    }"
                                >
                                </v-data-table>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>

                <!-- Add Token Dialog -->
                <v-dialog v-model="showAddTokenDialog" max-width="500px">
                    <v-card>
                        <v-card-title>Add New Token</v-card-title>
                        <v-card-text>
                            <v-form ref="tokenForm">
                                <v-text-field
                                    v-model="newToken.name"
                                    label="Name"
                                    required
                                    :rules="[v => !!v || 'Name is required']"
                                ></v-text-field>
                                <v-text-field
                                    v-model="newToken.symbol"
                                    label="Symbol"
                                    required
                                    :rules="[v => !!v || 'Symbol is required']"
                                ></v-text-field>
                                <v-text-field
                                    v-model="newToken.denom"
                                    label="Denom"
                                    required
                                    :rules="[v => !!v || 'Denom is required']"
                                ></v-text-field>
                                <v-text-field
                                    v-model.number="newToken.decimals"
                                    label="Decimals"
                                    type="number"
                                    required
                                    :rules="[
                                        v => !!v || 'Decimals is required',
                                        v => v >= 0 || 'Decimals must be non-negative'
                                    ]"
                                ></v-text-field>
                            </v-form>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn color="error" text @click="showAddTokenDialog = false">Cancel</v-btn>
                            <v-btn 
                                color="primary" 
                                @click="deployToken"
                                :loading="isDeployingToken"
                            >
                                Deploy
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
            </v-container>

            <!-- Settings Page -->
            <v-container v-else-if="showSettingsPage">
                <v-row>
                    <v-col cols="12">
                        <v-card>
                            <v-card-title>
                                Chain {{ selectedChainId }} Settings
                                <v-spacer></v-spacer>
                                <v-btn color="primary" @click="updateSettings" :loading="isUpdatingSettings">
                                    Update
                                </v-btn>
                                <v-btn color="secondary" class="ml-2" @click="showSettingsPage = false">
                                    Back to Chains
                                </v-btn>
                            </v-card-title>
                            <v-card-text>
                                <v-textarea
                                    v-model="chainSettings"
                                    label="Settings"
                                    auto-grow
                                    rows="20"
                                    :error-messages="settingsError"
                                    @input="validateJson"
                                ></v-textarea>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>
            </v-container>

            <!-- Snackbar for notifications -->
            <v-snackbar
                v-model="snackbar.show"
                :color="snackbar.color"
                :timeout="3000"
            >
                {{ snackbar.text }}
                <template v-slot:action="{ attrs }">
                    <v-btn
                        text
                        v-bind="attrs"
                        @click="snackbar.show = false"
                    >
                        Close
                    </v-btn>
                </template>
            </v-snackbar>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data: {
                isAuthenticated: false,
                password: '',
                showPassword: false,
                error: null,
                chains: {},
                showAddChainDialog: false,
                showProposeDialog: false,
                showTokensPage: false,
                showRpcsPage: false,
                showSettingsPage: false,
                showAddTokenDialog: false,
                showAddRpcsDialog: false,
                selectedChainId: null,
                newChainId: '',
                isProposing: false,
                isDeploying: false,
                isDeployingToken: false,
                isLoadingTokens: false,
                isLoadingRpcs: false,
                isAddingRpcs: false,
                isDeletingRpc: null,
                isLoadingTransactions: false,
                isUpdatingSettings: false,
                tokens: [],
                rpcs: [],
                staticRpcs: [],
                transactions: [],
                tableOptions: {},
                transactionTableOptions: {},
                totalItems: 0,
                totalTransactions: 0,
                newToken: {
                    name: '',
                    symbol: '',
                    denom: '',
                    decimals: 18
                },
                proposeForm: {
                    title: '',
                    description: '',
                    bridge_chain_id: null,
                    bridge_chain_name: '',
                    average_counterparty_block_time: 12000
                },
                snackbar: {
                    show: false,
                    text: '',
                    color: 'success'
                },
                walletAddress: '',
                newRpcs: '',
                chainSettings: '',
                settingsError: ''
            },
            mounted() {
                const storedPassword = localStorage.getItem('password');
                if (storedPassword) {
                    this.isAuthenticated = true;
                    this.fetchChains();
                    this.fetchTransactions();
                    this.fetchWalletAddress();
                }
            },
            watch: {
                tableOptions: {
                    handler() {
                        if (this.selectedChainId) {
                            this.viewTokens(this.selectedChainId);
                        }
                    },
                    deep: true
                },
                transactionTableOptions: {
                    handler() {
                        this.fetchTransactions();
                    },
                    deep: true
                }
            },
            methods: {
                showNotification(text, color = 'success') {
                    this.snackbar.text = text;
                    this.snackbar.color = color;
                    this.snackbar.show = true;
                },
                async viewTokens(chainId) {
                    this.selectedChainId = chainId;
                    this.showTokensPage = true;
                    this.tokens = [];
                    this.isLoadingTokens = true;

                    try {
                        const page = this.tableOptions.page || 1;
                        const itemsPerPage = this.tableOptions.itemsPerPage || 10;
                        
                        const response = await fetch(`/api/query?type=get-list-tokens&chain_id=${chainId}&page=${page}&size=${itemsPerPage}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch tokens');
                        }

                        const data = await response.json();
                        if (data.success && data.data.tokens) {
                            this.tokens = data.data.tokens.map(token => {
                                const chainMetadata = token.metadata.chainsMetadatas.find(x => x.chainId == chainId);

                                let originChainId = 42000;
                                const originMetadata = token.metadata.chainsMetadatas.find(x => x.isOriginated === true);

                                if (originMetadata) {
                                    originChainId = originMetadata.chainId;
                                }

                                return {
                                    name: token.metadata.name,
                                    symbol: token.metadata.symbol,
                                    decimals: token.metadata.decimals,
                                    contract_address: token.metadata.contract_address,
                                    chain_contract_address: chainMetadata?.contractAddress || 'N/A',
                                    origin_chain_id: originChainId,
                                }
                        });
                            this.totalItems = data.data.total;
                        }
                    } catch (error) {
                        console.error('Error fetching tokens:', error);
                        this.showNotification('Failed to fetch tokens', 'error');
                    } finally {
                        this.isLoadingTokens = false;
                    }
                },
                async deployToken() {
                    if (!this.$refs.tokenForm.validate()) {
                        return;
                    }

                    this.isDeployingToken = true;
                    try {
                        const response = await fetch('/api/query?type=deploy-erc20', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chain_id: this.selectedChainId,
                                name: this.newToken.name,
                                symbol: this.newToken.symbol,
                                denom: this.newToken.denom,
                                decimals: this.newToken.decimals
                            }),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Failed to deploy token');
                        }

                        this.showAddTokenDialog = false;
                        this.newToken = {
                            name: '',
                            symbol: '',
                            denom: '',
                            decimals: 18
                        };
                        this.showNotification('Token deployed successfully');
                        // TODO: Refresh tokens list when API endpoint is available
                    } catch (error) {
                        console.error('Error deploying token:', error);
                        this.showNotification(error.message, 'error');
                    } finally {
                        this.isDeployingToken = false;
                    }
                },
                async login() {
                    try {
                        const response = await fetch('/api/query?type=login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ password: this.password }),
                        });

                        if (!response.ok) {
                            throw new Error('Invalid password');
                        }

                        localStorage.setItem('password', this.password);
                        this.isAuthenticated = true;
                        this.error = null;
                        this.fetchChains();
                    } catch (error) {
                        this.error = error.message;
                    }
                },
                async fetchChains() {
                    try {
                        const response = await fetch('/api/query?type=get-list-hyperions');
                        if (!response.ok) {
                            throw new Error('Failed to fetch chains');
                        }
                        const resp = await response.json();
                        
                        // Fetch stats to get height information
                        const statsResponse = await fetch('/api/query?type=get-stats');
                        let stats = {};
                        if (statsResponse.ok) {
                            const statsData = await statsResponse.json();
                            if (statsData.success && statsData.data) {
                                stats = statsData.data;
                            }
                        }
                        
                        // Add isLoading property to each chain and sync status
                        this.chains = [];
                        Object.keys(resp.data).forEach(key => {
                            const chain = resp.data[key];
                            const chainStats = stats[key] || {};
                            const height = chainStats.height || 0;
                            const targetHeight = chainStats.targetHeight || 0;
                            const heightDiff = Math.abs(targetHeight - height);
                            const isSynced = heightDiff <= 1000;
                            
                            this.chains.push({
                                ...chain,
                                isLoading: false,
                                height: height,
                                targetHeight: targetHeight,
                                isSynced: isSynced,
                                heightDiff: heightDiff,
                                totalTxs: chainStats.totalTxs || 0,
                                batches: chainStats.batches || 0
                            });
                        });
                    } catch (error) {
                        console.error('Error fetching chains:', error);
                        this.showNotification('Failed to fetch chains', 'error');
                    }
                },
                async runHyperion(chainId) {
                    try {
                        // Set loading state
                        this.chains.find(chain => chain.chainId === chainId).isLoading = true;

                        const response = await fetch('/api/query?type=run-hyperion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ chain_id: chainId }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to run Hyperion');
                        }

                        // Show success message
                        this.showNotification(`Hyperion started successfully for chain ${chainId}`);
                        
                        // Refresh the chains list
                        await this.fetchChains();
                    } catch (error) {
                        console.error('Error running Hyperion:', error);
                        this.showNotification(`Failed to run Hyperion: ${error.message}`, 'error');
                    } finally {
                        // Clear loading state if the chain still exists
                        if (this.chains.find(chain => chain.chainId === chainId)) {
                            this.chains.find(chain => chain.chainId === chainId).isLoading = false;
                        }
                    }
                },
                async stopHyperion(chainId) {
                    try {
                        // Set loading state
                        this.chains.find(chain => chain.chainId === chainId).isLoading = true;

                        const response = await fetch('/api/query?type=stop-hyperion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ chain_id: chainId }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to stop Hyperion');
                        }

                        // Show success message
                        this.showNotification(`Hyperion stopped successfully for chain ${chainId}`);
                        
                        // Refresh the chains list
                        await this.fetchChains();
                    } catch (error) {
                        console.error('Error stopping Hyperion:', error);
                        this.showNotification(`Failed to stop Hyperion: ${error.message}`, 'error');
                    } finally {
                        // Clear loading state if the chain still exists
                        if (this.chains.find(chain => chain.chainId === chainId)) {
                            this.chains.find(chain => chain.chainId === chainId).isLoading = false;
                        }
                    }
                },
                async deployHyperion() {
                    if (!this.newChainId) {
                        this.showNotification('Please enter a Chain ID', 'error');
                        return;
                    }

                    this.isDeploying = true;
                    try {
                        const response = await fetch('/api/query?type=deploy-hyperion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ chain_id: Number(this.newChainId) }),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Failed to deploy Hyperion');
                        }

                        this.showAddChainDialog = false;
                        this.newChainId = '';
                        this.showNotification('Hyperion deployed successfully');
                        await this.fetchChains();
                    } catch (error) {
                        console.error('Error deploying Hyperion:', error);
                        this.showNotification(error.message, 'error');
                    } finally {
                        this.isDeploying = false;
                    }
                },
                openProposeDialog(chainId) {
                    this.proposeForm = {
                        title: '',
                        description: '',
                        bridge_chain_id: chainId,
                        bridge_chain_name: '',
                        average_counterparty_block_time: 12000
                    };
                    this.showProposeDialog = true;
                },
                async proposeHyperion() {
                    if (!this.$refs.proposeForm.validate()) {
                        return;
                    }

                    this.isProposing = true;
                    try {
                        const response = await fetch('/api/query?type=propose-hyperion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                title: this.proposeForm.title,
                                description: this.proposeForm.description,
                                bridge_chain_id: Number(this.proposeForm.bridge_chain_id),
                                bridge_chain_name: this.proposeForm.bridge_chain_name,
                                average_counterparty_block_time: Number(this.proposeForm.average_counterparty_block_time)
                            }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to propose Hyperion');
                        }

                        this.showProposeDialog = false;
                        this.showNotification('Hyperion proposed successfully');
                        await this.fetchChains();
                    } catch (error) {
                        console.error('Error proposing Hyperion:', error);
                        this.showNotification(`Failed to propose Hyperion: ${error.message}`, 'error');
                    } finally {
                        this.isProposing = false;
                    }
                },
                async unregisterHyperion(chainId) {
                    try {
                        // Find the chain and set its loading state
                        const chain = this.chains.find(chain => chain.chainId === chainId);
                        if (chain) {
                            chain.isLoading = true;
                        }

                        const response = await fetch('/api/query?type=unregister-hyperion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ chain_id: chainId }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to unregister Hyperion');
                        }

                        this.showNotification(`Hyperion unregistered successfully for chain ${chainId}`);
                        await this.fetchChains();
                    } catch (error) {
                        console.error('Error unregistering Hyperion:', error);
                        this.showNotification(`Failed to unregister Hyperion: ${error.message}`, 'error');
                    } finally {
                        // Clear loading state if the chain still exists
                        const chain = this.chains.find(chain => chain.chainId === chainId);
                        if (chain) {
                            chain.isLoading = false;
                        }
                    }
                },
                async registerHyperion(chainId) {
                    try {
                        // Find the chain and set its loading state
                        const chain = this.chains.find(chain => chain.chainId === chainId);
                        if (chain) {
                            chain.isLoading = true;
                        }

                        const response = await fetch('/api/query?type=register-hyperion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ chain_id: chainId }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to register Hyperion');
                        }

                        this.showNotification(`Hyperion registered successfully for chain ${chainId}`);
                        await this.fetchChains();
                    } catch (error) {
                        console.error('Error registering Hyperion:', error);
                        this.showNotification(`Failed to register Hyperion: ${error.message}`, 'error');
                    } finally {
                        // Clear loading state if the chain still exists
                        const chain = this.chains.find(chain => chain.chainId === chainId);
                        if (chain) {
                            chain.isLoading = false;
                        }
                    }
                },
                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showNotification('RPC URL copied to clipboard');
                    });
                },
                async viewRpcs(chainId) {
                    this.selectedChainId = chainId;
                    this.showRpcsPage = true;
                    this.rpcs = [];
                    this.isLoadingRpcs = true;

                    try {
                        const response = await fetch(`/api/query?type=get-list-rpcs&chain_id=${chainId}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch RPCs');
                        }

                        const data = await response.json();
                        if (data.success) {
                            this.rpcs = data.data.rpcs.sort((a, b) => b.reputation - a.reputation);
                            this.staticRpcs = data.data.staticRpcs;
                        }
                    } catch (error) {
                        console.error('Error fetching RPCs:', error);
                        this.showNotification('Failed to fetch RPCs', 'error');
                    } finally {
                        this.isLoadingRpcs = false;
                    }
                },
                async fetchTransactions() {
                    if (!this.isAuthenticated) return;
                    
                    this.isLoadingTransactions = true;
                    try {
                        const page = this.transactionTableOptions.page || 1;
                        const itemsPerPage = this.transactionTableOptions.itemsPerPage || 10;
                        
                        const response = await fetch(`/api/query?type=get-list-transactions&page=${page}&size=${itemsPerPage}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch transactions');
                        }

                        const data = await response.json();
                        if (data.success && data.data.transactions) {
                            this.transactions = data.data.transactions;
                            this.totalTransactions = data.data.total || this.transactions.length;
                        }
                    } catch (error) {
                        console.error('Error fetching transactions:', error);
                        this.showNotification('Failed to fetch transactions', 'error');
                    } finally {
                        this.isLoadingTransactions = false;
                    }
                },
                async fetchWalletAddress() {
                    try {
                        const response = await fetch('/api/query?type=get-wallet-address');
                        if (!response.ok) {
                            throw new Error('Failed to fetch wallet address');
                        }
                        const data = await response.json();
                        this.walletAddress = data.data.address;
                    } catch (error) {
                        console.error('Error fetching wallet address:', error);
                        this.showNotification('Failed to fetch wallet address', 'error');
                    }
                },
                async addRpcs() {
                    if (!this.$refs.rpcsForm.validate()) {
                        return;
                    }

                    this.isAddingRpcs = true;
                    try {
                        const rpcsArray = this.newRpcs.split('\n').map(rpc => rpc.trim()).filter(rpc => rpc);
                        const response = await fetch('/api/query?type=add-rpcs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chain_id: this.selectedChainId,
                                rpcs: rpcsArray.join(',')
                            }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to add RPCs');
                        }

                        this.showAddRpcsDialog = false;
                        this.newRpcs = '';
                        this.showNotification('RPCs added successfully');
                        await this.viewRpcs(this.selectedChainId);
                    } catch (error) {
                        console.error('Error adding RPCs:', error);
                        this.showNotification(error.message, 'error');
                    } finally {
                        this.isAddingRpcs = false;
                    }
                },
                async removeRpc(rpc) {
                    this.isDeletingRpc = rpc;
                    try {
                        const response = await fetch('/api/query?type=remove-rpcs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chain_id: this.selectedChainId,
                                rpcs: rpc
                            }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to remove RPC');
                        }

                        this.showNotification('RPC removed successfully');
                        await this.viewRpcs(this.selectedChainId);
                    } catch (error) {
                        console.error('Error removing RPC:', error);
                        this.showNotification(error.message, 'error');
                    } finally {
                        this.isDeletingRpc = null;
                    }
                },
                async viewSettings(chainId) {
                    this.selectedChainId = chainId;
                    this.showSettingsPage = true;
                    this.chainSettings = '';
                    this.settingsError = '';

                    try {
                        const response = await fetch(`/api/query?type=get-chain-settings&chain_id=${chainId}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch chain settings');
                        }

                        const data = await response.json();
                        if (data.success) {
                            // Format the JSON with proper indentation
                            this.chainSettings = JSON.stringify(data.data, null, 2);
                        }
                    } catch (error) {
                        console.error('Error fetching chain settings:', error);
                        this.showNotification('Failed to fetch chain settings', 'error');
                    }
                },
                validateJson() {
                    try {
                        JSON.parse(this.chainSettings);
                        this.settingsError = '';
                        return true;
                    } catch (error) {
                        this.settingsError = 'Invalid JSON format';
                        return false;
                    }
                },
                async updateSettings() {
                    if (!this.validateJson()) {
                        this.showNotification('Invalid JSON format', 'error');
                        return;
                    }

                    this.isUpdatingSettings = true;
                    try {
                        const response = await fetch('/api/query?type=update-chain-settings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chain_id: this.selectedChainId,
                                settings: JSON.parse(this.chainSettings)
                            }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update chain settings');
                        }

                        this.showNotification('Settings updated successfully');
                    } catch (error) {
                        console.error('Error updating chain settings:', error);
                        this.showNotification(error.message, 'error');
                    } finally {
                        this.isUpdatingSettings = false;
                    }
                },
            },
        });
    </script>
</body>
</html> 